function Controller(b,g){function a(a,d){var f=c.getBoundingClientRect(),s=document.body,e=document.documentElement;return{x:(a-(f.left+(g.pageXOffset||e.scrollLeft||s.scrollLeft)-(e.clientLeft||s.clientLeft||0))-b.offsetX)/b.scale,y:(d-(f.top+(g.pageYOffset||e.scrollTop||s.scrollTop)-(e.clientTop||s.clientTop||0))-b.offsetY)/b.scale}}function e(c,d,e){e&&(c=a(c,d),e(c.x,c.y)&&b.commit(f))}function d(c){if(f.wheel){var d=a(c.pageX,c.pageY);c.preventDefault();f.wheel(d.x,d.y,c.wheelDelta||-c.detail)&&
b.commit(f)}}function h(a){var c={},b=k[k.length-1],d;for(d in b)b.hasOwnProperty(d)&&"_"!=d[0]&&(c[d]=b[d]);for(d in a)a.hasOwnProperty(d)&&(c[d]=a[d]);a.leftdown&&!a.leftup?c.leftup=void 0:a.leftup&&!a.leftdown&&(c.leftdown=void 0);a.rightdown&&!a.rightup?c.rightup=void 0:a.rightup&&!a.rightdown&&(c.rightdown=void 0);f=c;f._enter&&f._enter()}document.oncontextmenu=function(){return!1};var c=b.canvas,f=null,k=[];this.states={};var l=null;c.onmousedown=function(a){var c=a.button;l=c;switch(c){case 0:e(a.pageX,
a.pageY,f.leftdown);break;case 2:e(a.pageX,a.pageY,f.rightdown)}};c.addEventListener("touchstart",function(a){c.onmousedown=void 0;c.onmouseup=void 0;c.onmousemove=void 0;var b=a.touches[0].pageX;a=a.touches[0].pageY;e(b,a,f.move);l=0;e(b,a,f.leftdown)});c.onmouseup=function(a){switch(l){case 0:e(a.pageX,a.pageY,f.leftup);break;case 2:e(a.pageX,a.pageY,f.rightup)}l=null};c.addEventListener("touchend",function(a){e(a.changedTouches[0].pageX,a.changedTouches[0].pageY,f.leftup)});c.onmousemove=function(a){e(a.pageX,
a.pageY,f.move)};var r=0;c.addEventListener("touchmove",function(a){+new Date<r||(e(a.touches[0].pageX,a.touches[0].pageY,f.move),r=+new Date+100)});c.ondblclick=function(a){e(a.pageX,a.pageY,f.dblclick);a.preventDefault()};c.addEventListener?(c.addEventListener("mousewheel",d,!1),c.addEventListener("DOMMouseScroll",d,!1)):c.attachEvent("onmousewheel",d);g.onresize=function(){b.onresize(f)};c.onkeydown=function(){alert("kd")};this.go=function(a){f?(f._leave&&f._leave(),h(a)):f=a};this.call=function(a){k.push(f);
h(a)};this.pop=function(){if(0==k.length)throw Error("Controller.pop() stack overrun!");f._leave&&f._leave();f=k.pop()}};var css={def:"#000",sel:"#F00",touch:"#888",back:"#FFF",font:"10px monospace"};function setCSS(b){document.getElementById("CSS").href=b;editor.OnCSS(b)};function Editor(b,g,a){function e(a,c,b,d){this.x=a;this.y=c;this.w=b;this.h=d;this.left=function(){return 0<this.w?this.x:this.x+this.w};this.top=function(){return 0<this.h?this.y:this.y+this.h};this.right=function(){return 0>this.w?this.x:this.x+this.w};this.bottom=function(){return 0>this.h?this.y:this.y+this.h};this.stroke=function(a){a.strokeStyle="#8080FF";a.strokeRect(this.x,this.y,this.w,this.h)}}this.mo=null;this.pointAlign=!0;var d=b.active,h=null,c=this;c.draw=function(a){a.lineCap="round";
a.lineJoin="round";var d=b.active,e=!0,f=[],g=[],h=[],k=c.mo,m;for(m in d){var n=d[m];if(n===k)(n._s&2?f:g).push(n),e=!1;else if(n._s&2)f.push(n);else if(n._s&1)g.push(n);else try{n.draw(a,0)}catch(l){d[m]&&h.push("#"+m+" "+d[m].constructor.name),d[m]=null}}for(m in f)try{f[m].draw(a,2)}catch(p){f[m]&&h.push("#"+m+" "+f[m].constructor.name)}for(m in g)try{g[m].draw(a,1)}catch(r){g[m]&&h.push("#"+m+" "+g[m].constructor.name)}e&&k&&k.draw(a,1);if(0<h.length){a=0;for(m in d)d[m]&&(d[a++]=d[m]);d.length=
a;alert("\u041e\u0448\u0438\u0431\u043a\u0430 \u043e\u0442\u0440\u0438\u0441\u043e\u0432\u043a\u0438 \u043e\u0431\u044a\u0435\u043a\u0442\u043e\u0432: \n"+h.join("\n"))}};var f,k,l={move:function(a,b){var e=a-f,h=b-k;f=a;k=b;var l=c.mo,q;for(q in d)d[q]._s&2&&d[q].moveBy&&d[q].moveBy(e,h);!l||l._s&2||!l.moveBy||l.moveBy(e,h);for(q in d)d[q]._s&=3;l&&(l._s&=3);return g.needRedraw=!0},leftup:a.pop},r={move:function(b,e){if(!(c.mo._s&2)){for(var f in d)d[f]._s&=-3;c.mo._s|=2}a.go(l);return l.move(b,
e)},leftup:function(d,b){a.pop();var e=c.mo;e._s&2?e._s&=-3:e._s|=2;return g.needRedraw=!0}},t={move:function(a,c){h.w=a-h.x;h.h=c-h.y;var d=h.left(),e=h.top(),f=h.right(),k=h.bottom(),l=b.active,m;for(m in l){var n=l[m];if(n.rHit){var p=n.rHit(d,e,f,k);p===!(n._s&1)&&(g.needRedraw=!0,p?n._s|=1:n._s&=-2)}}return!0},leftup:function(){for(var c in d){var b=d[c]._s;if(b&1){if(d[c].onSel&&!(b&2))d[c].onSel(!0);b|=2;b&=-2;d[c]._s=b}}a.pop();return g.needRedraw=!0},draw:function(a){h.stroke(a)}},u={move:function(c,
b){a.go(t);return t.move(c,b)},leftup:function(c,b){for(var e in d)if(d[e]._s&2){if(d[e].onSel)d[e].onSel(0);d[e]._s=0;g.needRedraw=!0}a.pop();return!0}},p={free:{move:function(a,b){for(var e=null,f=0,h=3/g.scale,k=d.length;k--;)if(!f||d[k].hp&&!(d[k].hp<f)){var l=d[k].hit(a,b,h);l&&(e=l,f=l.hp)}if(c.mo!=e)return c.mo&&(c.mo._s&=-2),c.mo=e,g.needRedraw=!0,e&&(e._s|=1),!0},leftdown:function(b,d){c.mo?(f=b,k=d,a.call(r)):(h=new e(b,d,0,0),a.call(u))},dblclick:function(a,b){var d=c.mo;if(d&&d.onDblClick)d.onDblClick(a,
b)},select:function(){a.call(p.select)},onlymove:function(){a.call(p.onlymove)}},select:{_enter:function(){CToolbar.select.check(!0)},leftdown:function(b,c){h=new e(b,c,0,0);a.call(p.selmove)},select:a.pop,onlymove:function(){a.go(p.onlymove)},_leave:function(){CToolbar.select.check(!1)}},onlymove:{_enter:function(){CToolbar.move.check(!0)},leftdown:function(b,c){Main.MX=b;Main.MY=c;h=new e(Main.MX,Main.MY,0,0);a.call(p.objonlymove)},onlymove:a.pop,select:function(){a.go(p.select)},_leave:function(){CToolbar.move.check(!1)}}};
a.states=p;a.go(p.free);g.needRedraw=!0;g.commit(p.free)};function Grid(b,g){var a=this;a.step=10;a.style="#808080";a.draw=function(e){var d=canvas.width,g=canvas.height;e.beginPath();var c,f=1/b.scale;e.lineWidth=.2;var k=a.step;for(c=Math.ceil(-b.offsetX/(k*b.scale))*k;c*b.scale+b.offsetX<d;c+=k)e.moveTo(c,-b.offsetY*f),e.lineTo(c,(g-b.offsetY)*f);for(c=Math.ceil(-b.offsetY/(k*b.scale))*k;c*b.scale+b.offsetY<g;c+=k)e.moveTo(-b.offsetX*f,c),e.lineTo((d-b.offsetX)*f,c);e.strokeStyle=a.style;e.stroke();e.lineWidth=1};g.align=function(b){b.x=Math.ceil(b.x/
a.step-1)*a.step;b.y=Math.ceil(b.y/a.step-1)*a.step};"undefined"!==typeof CMenu&&CMenu.Add({view:{grid:{label:"\u041b\u0438\u043d\u0435\u0439\u043a\u0430",_1:{label:"\u0420\u0435\u0448\u0451\u0442\u043a\u0430"},_2:{label:"\u0422\u043e\u0447\u043a\u0438"},_3:{label:"\u0423\u0431\u0440\u0430\u0442\u044c"},_4:{label:"\u041f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b"}}}})};function Navi(b,g){var a,e,d=g.states,h={move:function(c,d){b.offsetX+=c*b.scale-a;b.offsetY+=d*b.scale-e;b.transform();return!0},rightup:g.pop,leftup:g.pop};d.navi=h;d.free.rightdown=function(c,d){a=c*b.scale;e=d*b.scale;g.call(h)};d.free.wheel=function(a,c,d){if(d){var e=b.scale,g=1.2;0>d&&(g=1/g);b.scale*=g;e-=b.scale;b.offsetX+=a*e;b.offsetY+=c*e;b.transform();return!0}};if("undefined"!==typeof CToolbar){var c={_enter:function(){CToolbar.hand.check(!0)},leftdown:d.free.rightdown,hand:g.pop,_leave:function(){CToolbar.hand.check(!1)},
select:function(){g.go(d.select)},onlymove:function(){g.go(d.onlymove)}};d.hand=c;d.free.hand=function(){g.call(c)};d.select.hand=function(){g.go(c)};d.onlymove.hand=function(){g["goto"](c)}}};var storage=new function(){var b={sheets:{"\u043b\u0438\u0441\u0442 1":[]}};this.data=b;this.active=b.sheets["\u043b\u0438\u0441\u0442 1"];this.ctors={};this.getJSON=function(){workspace.sheets["\u043b\u0438\u0441\u0442 1"]=Items;return JSON.stringify(workspace,function(b,a){if("_"===b||"_"!==b.charAt(0)){if("object"===typeof a&&a.ctor){var e={_:a.ctor},d;for(d in a)a.hasOwnProperty(d)&&"function"!==typeof a[d]&&(e[d]=a[d]);var h=a.dep;for(d in h){var c=h[d];if(e[c]instanceof Array){var f=e[c],k=
[],l;for(l in f)k[l]=Main.GetId(f[l]);e[c]=k}else e[c]=Main.GetId(e[c])}return e}return a}})}};function pd(b,g){b._der?b._der.push(g):b._der=[g]}function rfa(b,g){for(var a=0,e=0,d=b.length;e<d;e++){var h=b[e];h!==g&&(b[a++]=h)}b.length=a};function View(b,g){var a=this;a.scale=1;a.offsetX=0;a.offsetY=0;a.canvas=g?g:b;var e=b.getContext("2d"),d=g.getContext("2d");a.onresize=function(c){var f=b.clientHeight,h=b.clientWidth;b.height=f;b.width=h;g&&(g.height=f,g.width=h);e.setTransform(a.scale,0,0,a.scale,a.offsetX,a.offsetY);d.setTransform(a.scale,0,0,a.scale,a.offsetX,a.offsetY);a.needRedraw=!0;a.commit(c)};a.seq=[];a.needRedraw=!0;var h=!1;a.commit=function(c){h&&d.clearRect(-a.offsetX/a.scale,-a.offsetY/a.scale,b.width/a.scale,b.height/
a.scale);c.draw&&(c.draw(d),h=!0);if(a.needRedraw){c=a.seq;for(var f in c)c[f](e);a.needRedraw=!1}};a.clear=function(c){c.clearRect(-a.offsetX/a.scale,-a.offsetY/a.scale,b.width/a.scale,b.height/a.scale)};a.transform=function(){e.setTransform(a.scale,0,0,a.scale,a.offsetX,a.offsetY);d.setTransform(a.scale,0,0,a.scale,a.offsetX,a.offsetY);a.needRedraw=!0}};var view=new View(document.getElementById("canvas"),document.getElementById("fast"));view.seq.push(view.clear);var ctl=new Controller(view,window),editor=new Editor(storage,view,ctl);Navi&&Navi(view,ctl);Grid&&(view.grid=new Grid(view,editor),view.seq.push(view.grid.draw));view.seq.push(editor.draw);window.onload=function(){window.onresize()};
